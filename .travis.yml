language: java

jdk:
- openjdk8

sudo: false
dist: trusty

# The cache is stored per-branch.

cache:
  directories:
  - $HOME/.m2

install:
- echo ==== Setting up toolchain.xml ====
- ls /usr/lib/jvm
- ls
- cp build-tools/src/main/toolchains/travis-ci.xml ~/.m2/toolchains.xml
- echo ==== Setting up Maven 3.3 for Travis ====
- wget -T 30 -t 3 -O maven.tar.gz http://www-eu.apache.org/dist/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz || wget -T 30 -t 3 -O maven.tar.gz http://www-us.apache.org/dist/maven/maven-3/3.3.9/binaries/apache-maven-3.3.9-bin.tar.gz
- mkdir maven
- cd maven ; tar --strip-components 1 -xzf ../maven.tar.gz ; cd ..
- chmod a+x maven/bin/mvn

before_script:
  - export IMAGE_TAG='1.0.4.1'
  - export M2_HOME=$PWD/maven
  - export PATH=${M2_HOME}/bin:${PATH}
  - export BUILD_OPTS=""
  - export CONFIG_OVERRIDES="-Dcommons.settings.hotswap=true"
  - export MAVEN_OPTS="-Xmx1024m"
  - hash -r

jobs:
  include:
  - stage: build
    script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - $M2_HOME/bin/mvn -v
      - $M2_HOME/bin/mvn -B -f external/pom.xml install
      - $M2_HOME/bin/mvn -B ${BUILD_OPTS} -DskipTests install
  - stage: dockerbuild
    script:
      - $M2_HOME/bin/mvn clean install -Pdocker,console -DskipTests
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - docker image ls --all
      - docker tag kapua/kapua-broker $DOCKER_REPO/kapua-broker:$IMAGE_TAG
      - docker push $DOCKER_REPO/kapua-broker
      - docker tag kapua/kapua-sql $DOCKER_REPO/kapua-sql:$IMAGE_TAG
      - docker push $DOCKER_REPO/kapua-sql
      - docker tag kapua/kapua-console $DOCKER_REPO/kapua-console:$IMAGE_TAG
      - docker push $DOCKER_REPO/kapua-console
      - docker tag kapua/kapua-api $DOCKER_REPO/kapua-api:$IMAGE_TAG
      - docker push $DOCKER_REPO/kapua-api
      - docker tag kapua/jetty-base $DOCKER_REPO/jetty-base:$IMAGE_TAG
      - docker push $DOCKER_REPO/jetty-base
      - docker tag kapua/kapua-events-broker $DOCKER_REPO/kapua-events-broker:$IMAGE_TAG
      - docker push $DOCKER_REPO/kapua-events-broker
      - docker tag kapua/java-base $DOCKER_REPO/java-base:$IMAGE_TAG
      - docker push $DOCKER_REPO/java-base
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @default" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @brokerAcl" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @tag" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @broker" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @device" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @connection" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @datastore" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @user" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @security" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - ./travis.sh $M2_HOME/bin/mvn -B ${BUILD_OPTS} ${CONFIG_OVERRIDES} -Dcucumber.options="--tags @jobs" verify
    - bash <(curl -s https://codecov.io/bash)
  - stage: test
    script:
    - $M2_HOME/bin/mvn -B -DskipTests install javadoc:jar

# The following upgrades Java during the build in
# order to work around an older Java 8 compiler issue
# which has problems infering types. Travis ships a
# rather old Java 8 version in its images.

addons:
  apt:
    packages:
    - openjdk-8-jdk
